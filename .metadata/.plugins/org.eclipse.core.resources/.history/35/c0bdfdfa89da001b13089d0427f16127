package com.group.mypage.dao;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

import com.group.employee.dto.Department;
import com.group.employee.dto.Employee;
import com.group.employee.dto.Job;
import com.group.employee.dto.Leave;
import com.group.employee.dto.Position;
import com.group.mypage.dto.EmployeeLeave;
import com.group.sql.MyConnection;

public class EmployeeLeaveDAOOracle implements EmployeeLeaveDAO{
	public EmployeeLeaveDAOOracle() throws Exception {
		Class.forName("oracle.jdbc.driver.OracleDriver");
		System.out.println("load success");
	}

	public EmployeeLeave selectById(String id) throws Exception{
		Connection con = null;
		try {
			con=MyConnection.getConnection();
		} catch (SQLException e) {
			e.printStackTrace();
		}
		
		String selectSQL = "SELECT *\r\n" + 
				"FROM employee e \r\n" + 
				"JOIN department d ON e.department_id = d.department_id\r\n" + 
				"JOIN position p ON e.position_id = p.position_id\r\n" + 
				"JOIN job j ON e.job_id = j.job_id\r\n" + 
				"JOIN leave l ON l.employee_id = e.employee_id \r\n" + 
				"WHERE e.employee_id=?";
		PreparedStatement pstmt=null;
		ResultSet rs = null;
		EmployeeLeave empleave = null;
		try {
			pstmt=con.prepareStatement(selectSQL);
			pstmt.setString(1, id);
			rs=pstmt.executeQuery();
			
			while(rs.next()) {
				Employee emp = new Employee();
				emp.setEmployee_id(rs.getString("employee_id"));
				emp.setName(rs.getString("name"));
				Department d = new Department();
				d.setDepartment_title(rs.getString("department_title"));
				emp.setDepartment(d);
				Position p = new Position();
				p.setPosition_title(rs.getString("position_title"));
				emp.setPosition(p);
				Job j = new Job();
				j.setJob_title(rs.getString("job_title"));
				emp.setJob(j);
				emp.setPhone_number(rs.getString("phone_number"));
				emp.setEmail(rs.getString("email"));
				emp.setHire_date(rs.getDate("hire_date"));
				emp.setPassword(rs.getString("password"));
				Leave leave = new Leave();
				leave.setGrant_days(rs.getInt("grant_days"));
				leave.setRemain_days(rs.getInt("remain_days"));
				leave.setUse_days(rs.getInt("grant_days")-rs.getInt("remain_days"));
				System.out.println("leave"+Leave);
				empleave.setEmployee(emp);
				empleave.setLeave(leave);
				System.out.println(empleave.getEmployee());
				System.out.println("---------------------------");
				System.out.println(empleave.getLeave());
			}
		} catch (SQLException e) {
			e.printStackTrace();
		}finally {
			MyConnection.close(con, pstmt, rs);
		}

		return empleave;
	}

	public void update(EmployeeLeave el) {
		// TODO Auto-generated method stub
		
	}
	public static void main(String[] args) {
		try {
			EmployeeLeaveDAOOracle dao = new EmployeeLeaveDAOOracle();
			String id = "DEV001";
			EmployeeLeave el = dao.selectById(id);
			System.out.println(el.getEmployee());
			System.out.println(el.getLeave());
		} catch (Exception e) {
			System.out.println(e.getMessage());
		}
	}

}
